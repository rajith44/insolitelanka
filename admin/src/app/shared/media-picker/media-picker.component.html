<div class="media-picker-modal">
  <div class="modal-header border-0 pb-0">
    <h5 class="modal-title">Media Library</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="cancel()"></button>
  </div>
  <div class="modal-body pt-2">
    <!-- Tabs: All / Images / Videos -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button type="button" class="nav-link" [class.active]="activeTab === 'all'" (click)="setTab('all')">
          All
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button type="button" class="nav-link" [class.active]="activeTab === 'image'" (click)="setTab('image')">
          Images
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button type="button" class="nav-link" [class.active]="activeTab === 'video'" (click)="setTab('video')">
          Videos
        </button>
      </li>
    </ul>

    <!-- Upload zone -->
    <div class="upload-zone border border-2 border-dashed rounded p-3 mb-3 bg-light text-center">
      <label class="mb-0 d-block cursor-pointer">
        <input
          type="file"
          class="d-none"
          accept="image/*,video/*"
          multiple
          [disabled]="uploading"
          (change)="onFileSelect($event)"
        />
        <i class="bx bx-cloud-upload fs-4 text-primary d-block mb-1"></i>
        <span class="text-muted small">{{ uploading ? 'Uploading...' : 'Upload new images or videos' }}</span>
      </label>
    </div>

    <!-- Media grid -->
    <div class="media-grid-wrapper">
      @if (loading) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted mb-0">Loading media...</p>
        </div>
      } @else if (items.length === 0) {
        <div class="text-center py-5 text-muted">
          <i class="bx bx-images display-4 d-block mb-2"></i>
          <p class="mb-0">No media yet. Upload images or videos above.</p>
        </div>
      } @else {
        <div class="row g-2 media-grid">
          @for (item of items; track item.id) {
            <div
              class="col-4 col-md-3 col-lg-2 cursor-pointer"
              [class.selected]="isSelected(item)"
              (click)="toggle(item)"
            >
              <div class="media-card card border h-100 cursor-pointer">
                <div class="position-relative thumb-wrap" style="aspect-ratio: 1; background: #f0f0f0;">
                  @if (isImage(item)) {
                    <img [src]="item.url" alt="" class="w-100 h-100 object-fit-cover" loading="lazy" />
                  } @else if (isVideo(item)) {
                    <video [src]="item.url" class="w-100 h-100 object-fit-cover" muted preload="metadata"></video>
                    <span class="badge bg-dark position-absolute bottom-0 start-0 m-1">Video</span>
                  } @else {
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                      <i class="bx bx-file fs-1"></i>
                    </div>
                  }
                  @if (isSelected(item)) {
                    <div class="selected-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                      <i class="bx bx-check-circle text-white fs-1 bg-primary rounded-circle p-1"></i>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Pagination -->
        @if (lastPage > 1) {
          <nav class="d-flex justify-content-center mt-3">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage <= 1">
                <button type="button" class="page-link" [disabled]="currentPage <= 1" (click)="loadPage(currentPage - 1)">
                  &laquo;
                </button>
              </li>
              @for (p of pages; track p) {
                <li class="page-item" [class.active]="currentPage === p">
                  <button type="button" class="page-link" (click)="loadPage(p)">{{ p }}</button>
                </li>
              }
              <li class="page-item" [class.disabled]="currentPage >= lastPage">
                <button type="button" class="page-link" [disabled]="currentPage >= lastPage" (click)="loadPage(currentPage + 1)">
                  &raquo;
                </button>
              </li>
            </ul>
          </nav>
        }
      }
    </div>

    @if (multiple && selected.length > 0) {
      <p class="small text-muted mt-2 mb-0">{{ selected.length }} item(s) selected.</p>
    }
  </div>
  <div class="modal-footer border-0 pt-0">
    <button type="button" class="btn btn-light" (click)="cancel()">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="selectAndClose()">
      {{ multiple ? 'Select' : 'Use this' }} {{ multiple && selected.length ? '(' + selected.length + ')' : '' }}
    </button>
  </div>
</div>
